<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>koperi</title>
    <style>
        :root {
            --primary-color: #1e90ff;
            --secondary-color: #f0f2f5;
            --accent-color: #ff4d4f;
            --text-color: #1a1a1a;
            --text-secondary: #65676b;
            --border-color: #dfe3ee;
            --white: #ffffff;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 6px 16px rgba(0, 0, 0, 0.2);
            --image-size: 60px;
            --media-height: 320px;
            --transition: all 0.3s ease;
        }

        [data-theme="dark"] {
            --primary-color: #61dafb;
            --secondary-color: #1c2526;
            --accent-color: #ff6b6b;
            --text-color: #e4e6eb;
            --text-secondary: #b0b3b8;
            --border-color: #3a3f47;
            --white: #22252d;
            --shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
            --shadow-hover: 0 6px 16px rgba(255, 255, 255, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--secondary-color);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 28px;
        }

        header {
            background: var(--white);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow);
        }

        header img {
            width: 28px;
            height: 28px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        #theme-toggle {
            margin-left: auto;
            padding: 10px 20px;
            background: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        #theme-toggle:hover {
            background: #0066cc;
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        #profile-section {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            position: sticky;
            top: 70px;
            transition: var(--transition);
            min-height: 500px;
        }

        #profile-section:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-4px);
        }

        #profile-header {
            text-align: center;
            margin-bottom: 20px;
        }

        #profile-pic {
            width: var(--image-size);
            height: var(--image-size);
            border-radius: 50%;
            border: 3px solid var(--primary-color);
            margin-bottom: 12px;
            transition: var(--transition);
            cursor: pointer;
        }

        #profile-pic:hover {
            transform: scale(1.1);
        }

        #profile-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
        }

        #profile-bio {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            min-height: 100px;
        }

        #profile-stats {
            display: flex;
            justify-content: space-around;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 20px;
            border-top: 1px solid var(--border-color);
            padding-top: 12px;
        }

        #menu-toggle {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 10px;
        }

        #menu-toggle span {
            display: block;
            width: 20px;
            height: 2px;
            background: var(--text-color);
            margin: 3px 0;
            transition: var(--transition);
        }

        #menu-options {
            display: none;
            text-align: center;
            margin-top: 10px;
        }

        #menu-options button {
            display: block;
            width: 100%;
            padding: 10px 20px;
            margin-bottom: 10px;
            background: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        #menu-options button:hover {
            background: #0066cc;
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        #home-logo {
            width: 28px;
            height: 28px;
            cursor: pointer;
            transition: var(--transition);
        }

        #home-logo:hover {
            transform: scale(1.1);
        }

        #forum-section, #video-section, #followers-section, #user-profile-section {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            position: relative;
            transition: var(--transition);
        }

        #forum-section:hover, #video-section:hover, #followers-section:hover, #user-profile-section:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-4px);
        }

        #section-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        #section-toggle button {
            flex: 1;
            padding: 10px 20px;
            font-size: 14px;
            background: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        #section-toggle button.active {
            background: var(--accent-color);
        }

        #section-toggle button:hover {
            background: #0066cc;
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        #search-bar {
            width: 100%;
            padding: 10px 10px 10px 36px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background: url('https://images.vexels.com/media/users/3/140723/isolated/preview/158241d2079a635fb0cae49accb56da5-icono-de-lupa.png') no-repeat 10px center;
            background-size: 20px;
            margin-bottom: 16px;
            transition: var(--transition);
        }

        #search-bar:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 8px rgba(0, 102, 204, 0.2);
            outline: none;
        }

        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 16px;
            resize: vertical;
            min-height: 90px;
            transition: var(--transition);
        }

        textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 8px rgba(0, 102, 204, 0.2);
            outline: none;
        }

        .file-input-wrapper {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: var(--primary-color);
            color: var(--white);
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .file-input-label:hover {
            background: #0066cc;
            transform: scale(1.1);
            box-shadow: var(--shadow-hover);
        }

        input[type="file"] {
            display: none;
        }

        .post {
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            transition: var(--transition);
        }

        .post:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-4px);
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .post-header img {
            width: var(--image-size);
            height: var(--image-size);
            border-radius: 50%;
            transition: var(--transition);
            cursor: pointer;
        }

        .post-header img:hover {
            transform: scale(1.1);
        }

        .post-header p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .post-header .username {
            font-weight: 600;
            color: var(--text-color);
            cursor: pointer;
        }

        .post-content p {
            font-size: 14px;
            margin-bottom: 12px;
        }

        .post-content img, .post-content video {
            width: 100%;
            max-height: var(--media-height);
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .video-player {
            position: relative;
            width: 100%;
            max-height: 400px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .video-player video {
            width: 100%;
            height: auto;
            pointer-events: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .post-actions {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
        }

        .post-actions button {
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--primary-color);
            color: var(--white);
            border: none;
            padding: 8px 16px;
            font-size: 13px;
            border-radius: 8px;
            transition: var(--transition);
            box-shadow: var(--shadow);
            cursor: pointer;
        }

        .post-actions button img {
            width: 20px;
            height: 20px;
        }

        .post-actions button:hover {
            background: #0066cc;
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .post-actions .like-btn.liked {
            background: var(--accent-color);
        }

        .post-actions .delete-btn {
            background: var(--accent-color);
        }

        .post-actions .delete-btn:hover {
            background: #cc0000;
        }

        .reply {
            margin-left: 20px;
            padding: 12px;
            background: var(--secondary-color);
            border-radius: 8px;
            margin-bottom: 12px;
            transition: var(--transition);
        }

        .reply:hover {
            box-shadow: var(--shadow);
            transform: translateY(-2px);
        }

        .modal-content {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow);
            transform: translateY(20px);
            animation: slideIn 0.3s ease forwards;
        }

        @keyframes slideIn {
            to {
                transform: translateY(0);
            }
        }

        .modal-content input, .modal-content textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 12px;
            transition: var(--transition);
        }

        .modal-content input:focus, .modal-content textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 8px rgba(0, 102, 204, 0.2);
            outline: none;
        }

        #notification-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            max-width: 300px;
            z-index: 1000;
        }

        .notification {
            background: var(--primary-color);
            color: var(--white);
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: var(--shadow);
            animation: fadeIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification img {
            width: 24px;
            height: 24px;
            margin-right: 8px;
        }

        .notification button {
            background: transparent;
            border: none;
            color: var(--white);
            font-size: 16px;
            cursor: pointer;
            margin-left: auto;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #toggle-post-form {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 36px;
            height: 36px;
            background: var(--primary-color);
            color: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 22px;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        #toggle-post-form:hover {
            background: #0066cc;
            transform: scale(1.1);
            box-shadow: var(--shadow-hover);
        }

        .follower-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .follower-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
        }

        .follower-item p {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-color);
        }

        .follower-item button {
            padding: 6px 12px;
            font-size: 12px;
            background: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: 8px;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .follower-item button:hover {
            background: #0066cc;
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            color: white;
            font-size: 24px;
        }

        #user-profile-section {
            display: none;
        }

        #user-profile-content {
            margin-top: 20px;
        }

        #back-to-home-profile, #go-back-profile {
            margin-top: 10px;
            padding: 10px 20px;
            background: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        #back-to-home-profile:hover, #go-back-profile:hover {
            background: #0066cc;
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                padding: 12px;
            }

            #profile-section {
                position: static;
            }

            #toggle-post-form {
                top: 12px;
                right: 12px;
            }
        }
    </style>
</head>
<body>
    <div id="loading-overlay">Cargando...</div>
    <header>
        <img src="https://images.vexels.com/media/users/3/140723/isolated/preview/158241d2079a635fb0cae49accb56da5-icono-de-lupa.png" alt="Logo">
        <h1>koperi</h1>
        <img id="home-logo" src="https://static.vecteezy.com/system/resources/previews/010/151/174/non_2x/house-and-home-icon-symbol-sign-free-png.png" alt="Inicio" onclick="goToHome()">
        <button id="theme-toggle">Cambiar a Tema Oscuro</button>
    </header>
    <div id="login-modal" style="display: none;">
        <div class="modal-content">
            <h2>Iniciar Sesión</h2>
            <input id="login-email" type="email" placeholder="Correo electrónico">
            <input id="login-password" type="password" placeholder="Contraseña">
            <button id="login-btn">Iniciar Sesión</button>
            <button id="register-btn">Registrarse</button>
            <p id="login-error" class="error"></p>
        </div>
    </div>
    <div id="modal" style="display: none;">
        <div class="modal-content">
            <h2>Configura tu Perfil</h2>
            <input type="text" id="modal-display-name" placeholder="Ingresa tu nombre">
            <input type="password" id="modal-password" placeholder="Nueva contraseña">
            <textarea id="modal-bio" placeholder="Escribe una breve biografía..."></textarea>
            <div class="file-input-wrapper">
                <label for="modal-profile-pic-input" class="file-input-label">📷</label>
                <input type="file" id="modal-profile-pic-input" accept="image/*" onchange="validateFile(this)">
            </div>
            <button id="modal-save-profile">Guardar Perfil</button>
            <button id="modal-delete-account">Eliminar Cuenta</button>
            <p id="modal-error" class="error"></p>
        </div>
    </div>
    <div id="notification-container"></div>
    <div class="container">
        <div id="profile-section" style="display: none;">
            <div id="profile-header">
                <img id="profile-pic" src="https://via.placeholder.com/60" alt="Foto de Perfil" onclick="viewUserProfile(clientId)">
                <div id="profile-name"></div>
                <div id="profile-bio"></div>
                <div id="profile-stats">
                    <div id="follower-count">Seguidores: 0</div>
                    <div id="post-count">Publicaciones: 0</div>
                </div>
                <div id="menu-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <div id="menu-options">
                    <button id="edit-profile">Editar Perfil</button>
                    <button id="view-followers">Ver Seguidores</button>
                    <button id="messages-btn">Mensajes</button>
                    <button id="logout-btn">Cerrar Sesión</button>
                </div>
            </div>
        </div>
        <div id="forum-section">
            <div id="section-toggle">
                <button id="show-posts" class="active">Publicaciones</button>
                <button id="show-videos">Videos</button>
                <button id="show-followers">Seguidores</button>
            </div>
            <input type="text" id="search-bar" placeholder="Buscar publicaciones, videos o usuarios...">
            <div id="toggle-post-form">+</div>
            <div id="post-form" style="display: none;">
                <textarea id="post-content" placeholder="Escribe tu mensaje..."></textarea>
                <div class="file-input-wrapper">
                    <label for="post-image" class="file-input-label">📷</label>
                    <input type="file" id="post-image" accept="image/*" onchange="validateFile(this)">
                    <label for="post-video" class="file-input-label">🎥</label>
                    <input type="file" id="post-video" accept="video/mp4,video/webm,video/ogg" onchange="validateFile(this)">
                </div>
                <button id="submit-post">Publicar</button>
                <p id="error" class="error"></p>
            </div>
            <h3>Publicaciones</h3>
            <div id="posts"></div>
        </div>
        <div id="video-section" style="display: none;">
            <h3>Videos</h3>
            <div class="video-player">
                <video id="main-video" controls>
                    <source src="https://sample-videos.com/video123/mp4/720/big_buck_bunny_720p_1mb.mp4" type="video/mp4">
                    Tu navegador no soporta video.
                </video>
            </div>
            <div id="videos"></div>
        </div>
        <div id="followers-section" style="display: none;">
            <h3>Seguidores</h3>
            <div id="followers"></div>
        </div>
        <div id="user-profile-section">
            <h3>Perfil de Usuario</h3>
            <div id="user-profile-content"></div>
            <button id="back-to-home-profile">Inicio</button>
            <button id="go-back-profile">Regresar</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword, deleteUser } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getDatabase, ref, set, onValue, get, remove, push, update, onChildAdded, onChildChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAd1GyJ7xsCjw_BkuEyBbzyyzbXjPH-Pww",
            authDomain: "luner-a8aae.firebaseapp.com",
            databaseURL: "https://luner-a8aae-default-rtdb.firebaseio.com",
            projectId: "luner-a8aae",
            storageBucket: "luner-a8aae.appspot.com",
            messagingSenderId: "792035263055",
            appId: "1:792035263055:web:d9d2b1c69153b04c82203a",
            measurementId: "G-Y0NWKHWKG6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        let clientId = localStorage.getItem('clientId');
        let profile = null;
        let currentSection = 'posts';
        let isLoading = true;

        const loginModal = document.getElementById('login-modal');
        const modal = document.getElementById('modal');
        const profileSection = document.getElementById('profile-section');
        const postsDiv = document.getElementById('posts');
        const videosDiv = document.getElementById('videos');
        const followersDiv = document.getElementById('followers');
        const errorDiv = document.getElementById('error');
        const notificationContainer = document.getElementById('notification-container');
        const forumSection = document.getElementById('forum-section');
        const videoSection = document.getElementById('video-section');
        const followersSection = document.getElementById('followers-section');
        const userProfileSection = document.getElementById('user-profile-section');
        const userProfileContent = document.getElementById('user-profile-content');
        const loadingOverlay = document.getElementById('loading-overlay');
        const menuToggle = document.getElementById('menu-toggle');
        const menuOptions = document.getElementById('menu-options');
        const mainVideo = document.getElementById('main-video');

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                loadingOverlay.style.display = 'none';
                initializeThemeToggle();
                initializeSectionToggle();
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const email = user.email.replace(/\./g, '_');
                        const profileSnapshot = await get(ref(database, `users/${email}/${clientId}`));
                        profile = profileSnapshot.val();
                        if (clientId && profile) {
                            localStorage.setItem('profile', JSON.stringify(profile));
                            profileSection.style.display = 'block';
                            loginModal.style.display = 'none';
                            modal.style.display = 'none';
                            initializePostsListener();
                            initializeFollowersListener();
                            initializeRealTimeNotifications();
                            updateProfileUI();
                        } else {
                            clientId = generateUUID();
                            localStorage.setItem('clientId', clientId);
                            loginModal.style.display = 'none';
                            modal.style.display = 'flex';
                        }
                    } else {
                        loginModal.style.display = 'flex';
                        profileSection.style.display = 'none';
                        modal.style.display = 'none';
                    }
                });
                menuToggle.addEventListener('click', () => {
                    menuOptions.style.display = menuOptions.style.display === 'block' ? 'none' : 'block';
                });
            }, 5000);
        });

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        window.validateFile = function(input) {
            const file = input.files[0];
            if (!file) return;
            const isVideo = input.accept.includes('video');
            const maxSizeMB = isVideo ? 50 : 10;
            if (file.size > maxSizeMB * 1024 * 1024) {
                errorDiv.textContent = `El archivo es demasiado grande. Máximo ${maxSizeMB}MB.`;
                input.value = '';
                return;
            }
            if (input.id.includes('image') && !['image/jpeg', 'image/png', 'image/gif'].includes(file.type)) {
                errorDiv.textContent = 'Selecciona una imagen válida (JPEG, PNG, GIF).';
                input.value = '';
            } else if (input.id.includes('video') && !['video/mp4', 'video/webm', 'video/ogg'].includes(file.type)) {
                errorDiv.textContent = 'Selecciona un video válido (MP4, WebM, OGG).';
                input.value = '';
            }
        };

        async function compressMedia(file, isVideo = false) {
            if (!file) return null;
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onerror = () => reject(new Error('Error al leer el archivo.'));
                reader.onload = (e) => {
                    if (!isVideo) {
                        const img = new Image();
                        img.onerror = () => reject(new Error('Error al cargar la imagen.'));
                        img.src = e.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const maxWidth = 600;
                            const maxHeight = 600;
                            let width = img.width;
                            let height = img.height;
                            if (width > height) {
                                if (width > maxWidth) {
                                    height = Math.round((height * maxWidth) / width);
                                    width = maxWidth;
                                }
                            } else {
                                if (height > maxHeight) {
                                    width = Math.round((width * maxHeight) / height);
                                    height = maxHeight;
                                }
                            }
                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', 0.7));
                        };
                    } else {
                        resolve(e.target.result);
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        function renderPosts(postsToRender, targetDiv = postsDiv) {
            targetDiv.innerHTML = '';
            if (!postsToRender || postsToRender.length === 0) {
                targetDiv.innerHTML = '<p>No hay contenido disponible.</p>';
                return;
            }
            postsToRender.forEach(post => {
                if (!post || !post.id || !post.content) return;
                if (targetDiv === videosDiv && !post.video) return;
                const postLikes = Array.isArray(post.likes) ? post.likes : [];
                const postElement = document.createElement('div');
                postElement.className = 'post';
                const mediaContent = post.image ? `<img src="${post.image}" alt="Imagen de Publicación" onerror="this.style.display='none';">` :
                                   post.video ? `<video controls src="${post.video}" onerror="this.style.display='none';"></video>` : '';
                const isFollowing = profile?.following?.includes(post.clientId) || false;
                const followButton = post.clientId !== clientId ? (isFollowing ? `<button class="unfollow-btn">Dejar de Seguir</button>` : `<button class="follow-btn">Seguir</button>`) : '';
                postElement.innerHTML = `
                    <div class="post-header">
                        <img src="${post.profilePic || 'https://via.placeholder.com/60'}" alt="Usuario" onclick="viewUserProfile('${post.clientId}')">
                        <p><strong class="username" data-client-id="${post.clientId}">${post.user || 'Anónimo'}</strong> (${new Date(post.timestamp || Date.now()).toLocaleString()}):</p>
                    </div>
                    <div class="post-content">
                        <p>${post.content}</p>
                        ${mediaContent}
                    </div>
                    <div class="post-actions">
                        <button class="like-btn ${postLikes.includes(clientId) ? 'liked' : ''}">
                            <img src="https://static.vecteezy.com/system/resources/previews/009/875/160/original/3d-love-heart-red-color-and-speech-bubble-free-png.png" alt="Like">
                            (${postLikes.length})
                        </button>
                        ${post.clientId === clientId ? `
                            <button class="edit-btn">Editar</button>
                            <button class="delete-btn">Eliminar</button>
                        ` : followButton}
                        <button class="reply-btn">
                            <img src="https://static.vecteezy.com/system/resources/previews/028/537/450/original/3d-comment-icon-free-png.png" alt="Comment">
                            Comentar (${Object.keys(post.replies || {}).length})
                        </button>
                    </div>
                    <div id="edit-form-${post.id}" style="display: none;">
                        <textarea id="edit-content-${post.id}">${post.content}</textarea>
                        <div class="file-input-wrapper">
                            <label for="edit-image-${post.id}" class="file-input-label">📷</label>
                            <input type="file" id="edit-image-${post.id}" accept="image/*" onchange="validateFile(this)">
                            <label for="edit-video-${post.id}" class="file-input-label">🎥</label>
                            <input type="file" id="edit-video-${post.id}" accept="video/mp4,video/webm,video/ogg" onchange="validateFile(this)">
                        </div>
                        <button class="edit-submit-btn">Guardar Cambios</button>
                    </div>
                    <div id="reply-form-${post.id}" style="display: none;">
                        <textarea id="reply-content-${post.id}" placeholder="Escribe tu respuesta..."></textarea>
                        <div class="file-input-wrapper">
                            <label for="reply-image-${post.id}" class="file-input-label">📷</label>
                            <input type="file" id="reply-image-${post.id}" accept="image/*" onchange="validateFile(this)">
                            <label for="reply-video-${post.id}" class="file-input-label">🎥</label>
                            <input type="file" id="reply-video-${post.id}" accept="video/mp4,video/webm,video/ogg" onchange="validateFile(this)">
                        </div>
                        <button class="reply-submit-btn">Enviar Respuesta</button>
                    </div>
                    <div class="replies">
                        ${post.replies ? Object.entries(post.replies).map(([replyId, reply]) => {
                            const replyLikes = Array.isArray(reply.likes) ? reply.likes : [];
                            return `
                            <div class="reply">
                                <div class="post-header">
                                    <img src="${reply.profilePic || 'https://via.placeholder.com/60'}" alt="Usuario" onclick="viewUserProfile('${reply.clientId}')">
                                    <p><strong class="username" data-client-id="${reply.clientId}">${reply.user || 'Anónimo'}</strong> (${new Date(reply.timestamp || Date.now()).toLocaleString()}):</p>
                                    ${reply.clientId === clientId ? `<button class="delete-reply-btn" data-reply-id="${replyId}">Eliminar</button>` : ''}
                                </div>
                                <p>${reply.content || ''}</p>
                                ${reply.image ? `<img src="${reply.image}" alt="Imagen de Respuesta" onerror="this.style.display='none';">` :
                                  reply.video ? `<video controls src="${reply.video}" onerror="this.style.display='none';"></video>` : ''}
                            </div>
                        `}).join('') : ''}
                    </div>
                `;
                targetDiv.appendChild(postElement);
                postElement.querySelector('.like-btn')?.addEventListener('click', () => toggleLike(post.id));
                postElement.querySelector('.edit-btn')?.addEventListener('click', () => editPost(post.id));
                postElement.querySelector('.delete-btn')?.addEventListener('click', () => deletePost(post.id));
                postElement.querySelector('.follow-btn')?.addEventListener('click', () => followUser(post.clientId));
                postElement.querySelector('.unfollow-btn')?.addEventListener('click', () => unfollowUser(post.clientId));
                postElement.querySelector('.reply-btn')?.addEventListener('click', () => showReplyForm(post.id));
                postElement.querySelector('.edit-submit-btn')?.addEventListener('click', () => submitEdit(post.id));
                postElement.querySelector('.reply-submit-btn')?.addEventListener('click', () => submitReply(post.id));
                postElement.querySelectorAll('.delete-reply-btn')?.forEach(btn => {
                    btn.addEventListener('click', () => deleteReply(post.id, btn.dataset.replyId));
                });
                if (targetDiv === videosDiv) {
                    const videoElement = postElement.querySelector('video');
                    if (videoElement) {
                        videoElement.addEventListener('contextmenu', (e) => e.preventDefault());
                        videoElement.controlsList = 'nodownload';
                    }
                }
            });
        }

        document.getElementById('login-btn').onclick = async () => {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();
            if (!email || !password) {
                document.getElementById('login-error').textContent = 'Ingresa correo y contraseña.';
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                document.getElementById('login-error').textContent = error.code === 'auth/wrong-password' ? 'Contraseña incorrecta.' : 'Error al iniciar sesión.';
            }
        };

        document.getElementById('register-btn').onclick = async () => {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();
            if (!email || !password) {
                document.getElementById('login-error').textContent = 'Ingresa correo y contraseña.';
                return;
            }
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                clientId = generateUUID();
                localStorage.setItem('clientId', clientId);
                modal.style.display = 'flex';
            } catch (error) {
                document.getElementById('login-error').textContent = error.code === 'auth/email-already-in-use' ? 'Correo ya registrado.' : 'Error al registrarse.';
            }
        };

        document.getElementById('logout-btn').onclick = async () => {
            if (confirm('¿Estás seguro de cerrar sesión?')) {
                await signOut(auth);
                localStorage.removeItem('clientId');
                localStorage.removeItem('profile');
                profileSection.style.display = 'none';
                loginModal.style.display = 'flex';
                showNotification('¡Sesión cerrada!');
            }
        };

        document.getElementById('messages-btn').onclick = () => {
            showNotification('Función de mensajes en desarrollo.');
        };

        function initializeThemeToggle() {
            const themeToggle = document.getElementById('theme-toggle');
            const currentTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            themeToggle.textContent = currentTheme === 'light' ? 'Cambiar a Tema Oscuro' : 'Cambiar a Tema Claro';
            themeToggle.addEventListener('click', () => {
                const newTheme = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                themeToggle.textContent = newTheme === 'light' ? 'Cambiar a Tema Oscuro' : 'Cambiar a Tema Claro';
            });
        }

        function initializeSectionToggle() {
            document.getElementById('show-posts').addEventListener('click', () => {
                currentSection = 'posts';
                forumSection.style.display = 'block';
                videoSection.style.display = 'none';
                followersSection.style.display = 'none';
                userProfileSection.style.display = 'none';
                document.getElementById('show-posts').classList.add('active');
                document.getElementById('show-videos').classList.remove('active');
                document.getElementById('show-followers').classList.remove('active');
                initializePostsListener();
            });
            document.getElementById('show-videos').addEventListener('click', () => {
                currentSection = 'videos';
                forumSection.style.display = 'none';
                videoSection.style.display = 'block';
                followersSection.style.display = 'none';
                userProfileSection.style.display = 'none';
                document.getElementById('show-videos').classList.add('active');
                document.getElementById('show-posts').classList.remove('active');
                document.getElementById('show-followers').classList.remove('active');
                initializePostsListener();
            });
            document.getElementById('show-followers').addEventListener('click', () => {
                currentSection = 'followers';
                forumSection.style.display = 'none';
                videoSection.style.display = 'none';
                followersSection.style.display = 'block';
                userProfileSection.style.display = 'none';
                document.getElementById('show-followers').classList.add('active');
                document.getElementById('show-posts').classList.remove('active');
                document.getElementById('show-videos').classList.remove('active');
                renderFollowers();
            });
        }

        document.getElementById('toggle-post-form').addEventListener('click', () => {
            const postForm = document.getElementById('post-form');
            postForm.style.display = postForm.style.display === 'none' ? 'block' : 'none';
            if (postForm.style.display === 'block' && !mainVideo.paused) {
                mainVideo.pause();
            }
        });

        document.getElementById('view-followers').addEventListener('click', () => {
            currentSection = 'followers';
            forumSection.style.display = 'none';
            videoSection.style.display = 'none';
            followersSection.style.display = 'block';
            userProfileSection.style.display = 'none';
            document.getElementById('show-followers').classList.add('active');
            document.getElementById('show-posts').classList.remove('active');
            document.getElementById('show-videos').classList.remove('active');
            renderFollowers();
        });

        document.getElementById('back-to-home-profile').addEventListener('click', () => {
            currentSection = 'posts';
            forumSection.style.display = 'block';
            videoSection.style.display = 'none';
            followersSection.style.display = 'none';
            userProfileSection.style.display = 'none';
            document.getElementById('show-posts').classList.add('active');
            document.getElementById('show-videos').classList.remove('active');
            document.getElementById('show-followers').classList.remove('active');
            initializePostsListener();
        });

        document.getElementById('go-back-profile').addEventListener('click', () => {
            userProfileSection.style.display = 'none';
            if (currentSection === 'posts') {
                forumSection.style.display = 'block';
            } else if (currentSection === 'videos') {
                videoSection.style.display = 'block';
            } else if (currentSection === 'followers') {
                followersSection.style.display = 'block';
            }
            initializePostsListener();
        });

        window.goToHome = function() {
            currentSection = 'posts';
            forumSection.style.display = 'block';
            videoSection.style.display = 'none';
            followersSection.style.display = 'none';
            userProfileSection.style.display = 'none';
            document.getElementById('show-posts').classList.add('active');
            document.getElementById('show-videos').classList.remove('active');
            document.getElementById('show-followers').classList.remove('active');
            initializePostsListener();
        };

        function updateProfileUI() {
            if (profile) {
                document.getElementById('profile-pic').src = profile.profilePic || 'https://via.placeholder.com/60';
                document.getElementById('profile-name').textContent = profile.displayName || 'Anónimo';
                document.getElementById('profile-bio').textContent = profile.bio || '';
                document.getElementById('follower-count').textContent = `Seguidores: ${profile.followers?.length || 0}`;
                document.getElementById('post-count').textContent = `Publicaciones: ${profile.postCount || 0}`;
            }
        }

        async function renderFollowers() {
            followersDiv.innerHTML = '';
            if (!profile?.followers?.length) {
                followersDiv.innerHTML = '<p>No tienes seguidores.</p>';
                return;
            }
            try {
                const usersRef = ref(database, 'users');
                const snapshot = await get(usersRef);
                const users = snapshot.val() || {};
                const followerList = [];
                for (const [email, clientIds] of Object.entries(users)) {
                    for (const [id, userData] of Object.entries(clientIds)) {
                        if (typeof userData === 'object' && userData !== null && profile.followers.includes(id)) {
                            followerList.push({ clientId: id, ...userData, email });
                        }
                    }
                }
                if (followerList.length === 0) {
                    followersDiv.innerHTML = '<p>No tienes seguidores.</p>';
                    return;
                }
                followerList.forEach(follower => {
                    const followerElement = document.createElement('div');
                    followerElement.className = 'follower-item';
                    followerElement.innerHTML = `
                        <img src="${follower.profilePic || 'https://via.placeholder.com/40'}" alt="Foto de ${follower.displayName}" onclick="viewUserProfile('${follower.clientId}')">
                        <p>${follower.displayName || 'Anónimo'}</p>
                        <button class="unfollow-btn" data-client-id="${follower.clientId}">Dejar de Seguir</button>
                    `;
                    followersDiv.appendChild(followerElement);
                });
                followersDiv.querySelectorAll('.unfollow-btn').forEach(btn => {
                    btn.addEventListener('click', () => unfollowUser(btn.dataset.clientId));
                });
            } catch (error) {
                followersDiv.innerHTML = '<p>Error al cargar seguidores.</p>';
            }
        }

        async function initializeFollowersListener() {
            const usersRef = ref(database, 'users');
            onValue(usersRef, async (snapshot) => {
                const users = snapshot.val() || {};
                for (const [email, clientIds] of Object.entries(users)) {
                    for (const [id, userData] of Object.entries(clientIds)) {
                        if (id === clientId && typeof userData === 'object' && userData !== null) {
                            profile = { ...userData, email: email.replace(/_/g, '.'), clientId };
                            localStorage.setItem('profile', JSON.stringify(profile));
                            updateProfileUI();
                            break;
                        }
                    }
                }
            }, (error) => {
                errorDiv.textContent = 'Error al actualizar seguidores.';
            });
        }

        async function followUser(targetClientId) {
            if (!profile || targetClientId === clientId) return;
            try {
                const email = profile.email.replace(/\./g, '_');
                const targetUserRef = ref(database, `users/${email}/${targetClientId}`);
                const targetSnapshot = await get(targetUserRef);
                const targetProfile = targetSnapshot.val();
                if (targetProfile && !targetProfile.followers?.includes(clientId)) {
                    const updatedFollowers = [...(targetProfile.followers || []), clientId];
                    await update(targetUserRef, { followers: updatedFollowers });
                    showNotification('¡Te empezó a seguir alguien!', true, targetClientId);
                }
                const userRef = ref(database, `users/${email}/${clientId}`);
                const userSnapshot = await get(userRef);
                const userProfile = userSnapshot.val() || {};
                if (!userProfile.following?.includes(targetClientId)) {
                    const updatedFollowing = [...(userProfile.following || []), targetClientId];
                    await update(userRef, { following: updatedFollowing });
                    profile.following = updatedFollowing;
                    localStorage.setItem('profile', JSON.stringify(profile));
                    initializePostsListener();
                }
            } catch (error) {
                errorDiv.textContent = 'Error al seguir usuario.';
            }
        }

        async function unfollowUser(targetClientId) {
            if (!profile || targetClientId === clientId) return;
            try {
                const email = profile.email.replace(/\./g, '_');
                const targetUserRef = ref(database, `users/${email}/${targetClientId}`);
                const targetSnapshot = await get(targetUserRef);
                const targetProfile = targetSnapshot.val();
                if (targetProfile && targetProfile.followers?.includes(clientId)) {
                    const updatedFollowers = targetProfile.followers.filter(id => id !== clientId);
                    await update(targetUserRef, { followers: updatedFollowers });
                    showNotification('¡Alguien dejó de seguirte!', true, targetClientId);
                }
                const userRef = ref(database, `users/${email}/${clientId}`);
                const userSnapshot = await get(userRef);
                const userProfile = userSnapshot.val() || {};
                if (userProfile.following?.includes(targetClientId)) {
                    const updatedFollowing = userProfile.following.filter(id => id !== targetClientId);
                    await update(userRef, { following: updatedFollowing });
                    profile.following = updatedFollowing;
                    localStorage.setItem('profile', JSON.stringify(profile));
                    initializePostsListener();
                }
            } catch (error) {
                errorDiv.textContent = 'Error al dejar de seguir usuario.';
            }
        }

        async function filterPostsAndUsers(searchTerm) {
            const postsRef = ref(database, 'posts');
            const usersRef = ref(database, 'users');
            const [postsSnapshot, usersSnapshot] = await Promise.all([get(postsRef), get(usersRef)]);
            const posts = [];
            postsSnapshot.forEach(child => {
                const postData = child.val();
                if (postData && postData.id && postData.content) {
                    postData.likes = Array.isArray(postData.likes) ? postData.likes : [];
                    if (postData.replies) {
                        Object.values(postData.replies).forEach(reply => {
                            reply.likes = Array.isArray(reply.likes) ? reply.likes : [];
                        });
                    }
                    posts.push(postData);
                }
            });
            const users = [];
            usersSnapshot.forEach(emailNode => {
                emailNode.forEach(clientNode => {
                    const userData = clientNode.val();
                    if (typeof userData === 'object' && userData !== null) {
                        users.push({
                            clientId: clientNode.key,
                            email: emailNode.key.replace(/_/g, '.'),
                            ...userData
                        });
                    }
                });
            });

            if (!searchTerm) return { posts, users: [] };
            searchTerm = searchTerm.toLowerCase();
            const filteredPosts = posts.filter(post =>
                (post.content || '').toLowerCase().includes(searchTerm) ||
                (post.user || '').toLowerCase().includes(searchTerm)
            );
            const filteredUsers = users.filter(user =>
                (user.displayName || '').toLowerCase().includes(searchTerm)
            );
            return { posts: filteredPosts, users: filteredUsers };
        }

        function initializePostsListener() {
            const postsRef = ref(database, 'posts');
            onValue(postsRef, (snapshot) => {
                const posts = [];
                snapshot.forEach(child => {
                    const postData = child.val();
                    if (postData && postData.id && postData.content) {
                        postData.likes = Array.isArray(postData.likes) ? postData.likes : [];
                        if (postData.replies) {
                            Object.values(postData.replies).forEach(reply => {
                                reply.likes = Array.isArray(reply.likes) ? reply.likes : [];
                            });
                        }
                        posts.push(postData);
                    }
                });
                const sortedPosts = posts.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                renderPosts(sortedPosts, currentSection === 'posts' ? postsDiv : videosDiv);
                if (currentSection === 'videos' && mainVideo) {
                    mainVideo.addEventListener('contextmenu', (e) => e.preventDefault());
                    mainVideo.controlsList = 'nodownload';
                }
            }, (error) => {
                errorDiv.textContent = 'Error al cargar contenido.';
            });
        }

        function initializeRealTimeNotifications() {
            const usersRef = ref(database, 'users');
            onChildChanged(usersRef, async (snapshot) => {
                const emailNode = snapshot.val();
                for (const [id, userData] of Object.entries(emailNode)) {
                    if (id === clientId && profile && userData.followers?.includes(clientId)) {
                        const followerSnapshot = await get(ref(database, `users/${profile.email.replace(/\./g, '_')}/${clientId}`));
                        const followerProfile = followerSnapshot.val();
                        if (followerProfile && !profile.followers?.includes(clientId)) {
                            showNotification(`${followerProfile.displayName || 'Anónimo'} te empezó a seguir`, true);
                        }
                    }
                }
            });
            const postsRef = ref(database, 'posts');
            onChildChanged(postsRef, async (snapshot) => {
                const post = snapshot.val();
                if (!post || post.clientId === clientId || !profile) return;
                const postLikes = Array.isArray(post.likes) ? post.likes : [];
                const prevLikes = Array.isArray(post.prevLikes) ? post.prevLikes : [];
                if (postLikes.includes(clientId) && !prevLikes.includes(clientId)) {
                    const userSnapshot = await get(ref(database, `users/${post.email.replace(/\./g, '_')}/${post.clientId}`));
                    const user = userSnapshot.val();
                    if (typeof user === 'object' && user !== null) {
                        const message = post.video ? `${user.displayName || 'Anónimo'} le dio like a tu video` : `${user.displayName || 'Anónimo'} le dio like a tu publicación`;
                        showNotification(message, true, post.clientId);
                    }
                }
                if (post.replies) {
                    for (const [replyId, reply] of Object.entries(post.replies)) {
                        if (reply.clientId !== clientId && !post.prevReplies?.[replyId]) {
                            const userSnapshot = await get(ref(database, `users/${reply.email.replace(/\./g, '_')}/${reply.clientId}`));
                            const user = userSnapshot.val();
                            if (typeof user === 'object' && user !== null) {
                                showNotification(`${user.displayName || 'Anónimo'} comentó en tu ${post.video ? 'video' : 'publicación'}`, true, post.clientId);
                            }
                        }
                    }
                }
                await update(ref(database, `posts/${post.id}`), {
                    prevLikes: postLikes,
                    prevReplies: post.replies || {}
                });
            });
            onChildAdded(postsRef, async (snapshot) => {
                const post = snapshot.val();
                if (!post || post.clientId !== clientId || !profile) return;
                await update(ref(database, `posts/${post.id}`), { prevLikes: [], prevReplies: {} });
            });
        }

        document.getElementById('modal-save-profile').onclick = async () => {
            const name = document.getElementById('modal-display-name').value.trim();
            const password = document.getElementById('modal-password').value.trim();
            const bio = document.getElementById('modal-bio').value.trim();
            const file = document.getElementById('modal-profile-pic-input').files[0];
            if (!name) {
                document.getElementById('modal-error').textContent = 'Ingresa un nombre.';
                return;
            }
            try {
                let profilePicUrl = profile?.profilePic || 'https://via.placeholder.com/60';
                if (file) {
                    profilePicUrl = await compressMedia(file);
                }
                profile = {
                    displayName: name,
                    profilePic: profilePicUrl,
                    bio: bio || '',
                    email: auth.currentUser.email,
                    followers: profile?.followers || [],
                    postCount: profile?.postCount || 0,
                    following: profile?.following || []
                };
                if (password) {
                    await updatePassword(auth.currentUser, password);
                }
                await set(ref(database, `users/${auth.currentUser.email.replace(/\./g, '_')}/${clientId}`), profile);
                localStorage.setItem('profile', JSON.stringify(profile));
                updateProfileUI();
                modal.style.display = 'none';
                profileSection.style.display = 'block';
                showNotification('¡Perfil guardado!');
                initializePostsListener();
            } catch (error) {
                document.getElementById('modal-error').textContent = 'Error al guardar el perfil o actualizar la contraseña.';
            }
        };

        document.getElementById('modal-delete-account').onclick = async () => {
            if (confirm('¿Estás seguro de eliminar tu cuenta? Esta acción no se puede deshacer.')) {
                try {
                    await deleteUser(auth.currentUser);
                    await remove(ref(database, `users/${auth.currentUser.email.replace(/\./g, '_')}/${clientId}`));
                    localStorage.removeItem('clientId');
                    localStorage.removeItem('profile');
                    profileSection.style.display = 'none';
                    loginModal.style.display = 'flex';
                    showNotification('¡Cuenta eliminada!');
                } catch (error) {
                    document.getElementById('modal-error').textContent = 'Error al eliminar la cuenta.';
                }
            }
        };

        document.getElementById('edit-profile').onclick = () => {
            modal.style.display = 'flex';
            document.getElementById('modal-display-name').value = profile.displayName || '';
            document.getElementById('modal-password').value = '';
            document.getElementById('modal-bio').value = profile.bio || '';
        };

        document.getElementById('submit-post').onclick = async () => {
            const content = document.getElementById('post-content').value.trim();
            if (!content) {
                errorDiv.textContent = 'Ingresa un mensaje.';
                return;
            }
            try {
                const imageFile = document.getElementById('post-image').files[0];
                const videoFile = document.getElementById('post-video').files[0];
                if (imageFile && videoFile) {
                    errorDiv.textContent = 'Selecciona solo una imagen o un video.';
                    return;
                }
                let imageUrl = null, videoUrl = null;
                if (imageFile) {
                    imageUrl = await compressMedia(imageFile);
                } else if (videoFile) {
                    videoUrl = await compressMedia(videoFile, true);
                    if (!mainVideo.paused) mainVideo.pause();
                }
                const newPost = {
                    id: generateUUID(),
                    content: content,
                    user: profile.displayName,
                    profilePic: profile.profilePic,
                    clientId: clientId,
                    timestamp: Date.now(),
                    image: imageUrl,
                    video: videoUrl,
                    replies: {},
                    likes: [],
                    prevLikes: [],
                    prevReplies: {},
                    followers: [],
                    email: auth.currentUser.email
                };
                await set(ref(database, 'posts/' + newPost.id), newPost);
                await update(ref(database, `users/${auth.currentUser.email.replace(/\./g, '_')}/${clientId}`), {
                    postCount: (profile.postCount || 0) + 1
                });
                document.getElementById('post-form').style.display = 'none';
                document.getElementById('post-content').value = '';
                document.getElementById('post-image').value = '';
                document.getElementById('post-video').value = '';
                showNotification('¡Publicación creada!');
            } catch (error) {
                errorDiv.textContent = 'Error al publicar.';
            }
        };

        window.deletePost = async (postId) => {
            try {
                const postRef = ref(database, 'posts/' + postId);
                const snapshot = await get(postRef);
                if (snapshot.val()?.clientId === clientId) {
                    await remove(postRef);
                    await update(ref(database, `users/${auth.currentUser.email.replace(/\./g, '_')}/${clientId}`), {
                        postCount: Math.max(0, (profile.postCount || 0) - 1)
                    });
                    showNotification('¡Publicación eliminada!');
                } else {
                    errorDiv.textContent = 'No tienes permiso para eliminar esta publicación.';
                }
            } catch (error) {
                errorDiv.textContent = 'Error al eliminar publicación.';
            }
        };

        window.editPost = (postId) => {
            document.getElementById(`edit-form-${postId}`).style.display = 'block';
        };

        window.submitEdit = async (postId) => {
            const content = document.getElementById(`edit-content-${postId}`).value.trim();
            if (!content) {
                errorDiv.textContent = 'Ingresa un mensaje.';
                return;
            }
            try {
                const imageFile = document.getElementById(`edit-image-${postId}`).files[0];
                const videoFile = document.getElementById(`edit-video-${postId}`).files[0];
                if (imageFile && videoFile) {
                    errorDiv.textContent = 'Selecciona solo una imagen o un video.';
                    return;
                }
                let imageUrl = null, videoUrl = null;
                if (imageFile) {
                    imageUrl = await compressMedia(imageFile);
                } else if (videoFile) {
                    videoUrl = await compressMedia(videoFile, true);
                }
                const postRef = ref(database, 'posts/' + postId);
                const snapshot = await get(postRef);
                if (snapshot.val()?.clientId === clientId) {
                    await update(postRef, { content, image: imageUrl, video: videoUrl });
                    document.getElementById(`edit-form-${postId}`).style.display = 'none';
                    showNotification('¡Publicación actualizada!');
                } else {
                    errorDiv.textContent = 'No tienes permiso para editar esta publicación.';
                }
            } catch (error) {
                errorDiv.textContent = 'Error al actualizar publicación.';
            }
        };

        window.toggleLike = async (postId) => {
            try {
                const postRef = ref(database, `posts/${postId}`);
                const snapshot = await get(postRef);
                const postData = snapshot.val();
                let likes = Array.isArray(postData?.likes) ? postData.likes : [];
                if (likes.includes(clientId)) {
                    likes = likes.filter(id => id !== clientId);
                } else {
                    likes.push(clientId);
                }
                await update(postRef, { likes });
                showNotification('¡Like actualizado!');
            } catch (error) {
                errorDiv.textContent = 'Error al actualizar like.';
            }
        };

        window.showReplyForm = (postId) => {
            document.getElementById(`reply-form-${postId}`).style.display = 'block';
        };

        window.submitReply = async (postId) => {
            const content = document.getElementById(`reply-content-${postId}`).value.trim();
            if (!content) {
                errorDiv.textContent = 'Ingresa una respuesta.';
                return;
            }
            try {
                const imageFile = document.getElementById(`reply-image-${postId}`).files[0];
                const videoFile = document.getElementById(`reply-video-${postId}`).files[0];
                if (imageFile && videoFile) {
                    errorDiv.textContent = 'Selecciona solo una imagen o un video.';
                    return;
                }
                let imageUrl = null, videoUrl = null;
                if (imageFile) {
                    imageUrl = await compressMedia(imageFile);
                } else if (videoFile) {
                    videoUrl = await compressMedia(videoFile, true);
                }
                const reply = {
                    content: content,
                    user: profile.displayName,
                    profilePic: profile.profilePic,
                    clientId: clientId,
                    timestamp: Date.now(),
                    image: imageUrl,
                    video: videoUrl,
                    likes: [],
                    email: auth.currentUser.email
                };
                await push(ref(database, `posts/${postId}/replies`), reply);
                document.getElementById(`reply-form-${postId}`).style.display = 'none';
                document.getElementById(`reply-content-${postId}`).value = '';
                document.getElementById(`reply-image-${postId}`).value = '';
                document.getElementById(`reply-video-${postId}`).value = '';
                showNotification('¡Respuesta publicada!');
            } catch (error) {
                errorDiv.textContent = 'Error al publicar respuesta.';
            }
        };

        window.deleteReply = async (postId, replyId) => {
            try {
                const replyRef = ref(database, `posts/${postId}/replies/${replyId}`);
                const snapshot = await get(replyRef);
                if (snapshot.val()?.clientId === clientId) {
                    await remove(replyRef);
                    showNotification('¡Respuesta eliminada!');
                } else {
                    errorDiv.textContent = 'No tienes permiso para eliminar esta respuesta.';
                }
            } catch (error) {
                errorDiv.textContent = 'Error al eliminar respuesta.';
            }
        };

        async function viewUserProfile(targetClientId) {
            if (!profile) return;
            try {
                const usersRef = ref(database, 'users');
                const snapshot = await get(usersRef);
                const users = snapshot.val() || {};
                let targetProfile = null;
                for (const [email, clientIds] of Object.entries(users)) {
                    for (const [id, userData] of Object.entries(clientIds)) {
                        if (id === targetClientId && typeof userData === 'object' && userData !== null) {
                            targetProfile = { ...userData, email: email.replace(/_/g, '.'), clientId: id };
                            break;
                        }
                    }
                    if (targetProfile) break;
                }
                if (targetProfile) {
                    currentSection = 'user-profile';
                    forumSection.style.display = 'none';
                    videoSection.style.display = 'none';
                    followersSection.style.display = 'none';
                    userProfileSection.style.display = 'block';
                    const isFollowing = profile?.following?.includes(targetClientId) || false;
                    const followButton = targetClientId !== clientId ? (isFollowing ? `<button class="unfollow-btn" onclick="unfollowUser('${targetClientId}')">Dejar de Seguir</button>` : `<button class="follow-btn" onclick="followUser('${targetClientId}')">Seguir</button>`) : '';
                    const postsRef = ref(database, 'posts');
                    const postsSnapshot = await get(postsRef);
                    const userPosts = [];
                    postsSnapshot.forEach(child => {
                        const postData = child.val();
                        if (postData && postData.clientId === targetClientId) {
                            postData.likes = Array.isArray(postData.likes) ? postData.likes : [];
                            if (postData.replies) {
                                Object.values(postData.replies).forEach(reply => {
                                    reply.likes = Array.isArray(reply.likes) ? reply.likes : [];
                                });
                            }
                            userPosts.push(postData);
                        }
                    });
                    const sortedPosts = userPosts.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                    userProfileContent.innerHTML = `
                        <img src="${targetProfile.profilePic || 'https://via.placeholder.com/60'}" alt="Foto de Perfil" style="width: 60px; height: 60px; border-radius: 50%; border: 3px solid var(--primary-color);">
                        <h3>${targetProfile.displayName || 'Anónimo'}</h3>
                        <p>Seguidores: ${targetProfile.followers?.length || 0}</p>
                        <p>Publicaciones: ${targetProfile.postCount || 0}</p>
                        ${followButton}
                        <h4>Publicaciones</h4>
                        <div id="user-posts">${sortedPosts.length > 0 ? '' : '<p>Este usuario no ha publicado nada.</p>'}</div>
                    `;
                    renderPosts(sortedPosts, document.getElementById('user-posts'));
                } else {
                    userProfileContent.innerHTML = '<p>Perfil no encontrado.</p>';
                }
            } catch (error) {
                userProfileContent.innerHTML = '<p>Error al cargar el perfil.</p>';
            }
        }

        window.viewUserProfile = viewUserProfile;

        document.getElementById('profile-pic').addEventListener('click', () => {
            viewUserProfile(clientId);
        });

        function showNotification(message, realTime = false, targetClientId = null) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <img src="https://via.placeholder.com/24" alt="Notificación" class="notification-logo">
                ${message}
                <button onclick="this.parentElement.remove()">✕</button>
            `;
            notificationContainer.appendChild(notification);
            if (!realTime) {
                setTimeout(() => notification.remove(), 5000);
            } else {
                notification.addEventListener('click', () => {
                    notification.remove();
                    if (message.includes('te empezó a seguir') || message.includes('dejó de seguirte')) {
                        viewUserProfile(targetClientId);
                    } else if (message.includes('le dio like') || message.includes('comentó')) {
                        currentSection = 'posts';
                        forumSection.style.display = 'block';
                        videoSection.style.display = 'none';
                        followersSection.style.display = 'none';
                        userProfileSection.style.display = 'none';
                        document.getElementById('show-posts').classList.add('active');
                        document.getElementById('show-videos').classList.remove('active');
                        document.getElementById('show-followers').classList.remove('active');
                        initializePostsListener();
                    }
                });
            }
        }

        document.getElementById('search-bar').addEventListener('input', async () => {
            const searchTerm = document.getElementById('search-bar').value;
            const { posts, users } = await filterPostsAndUsers(searchTerm);
            if (currentSection === 'posts') {
                renderPosts(posts.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)), postsDiv);
                if (users.length > 0) {
                    const userResults = document.createElement('div');
                    userResults.innerHTML = '<h3>Usuarios</h3>';
                    users.forEach(user => {
                        const userElement = document.createElement('div');
                        userElement.className = 'follower-item';
                        const isFollowing = profile?.following?.includes(user.clientId) || false;
                        const followButton = isFollowing ? `<button class="unfollow-btn" data-client-id="${user.clientId}">Dejar de Seguir</button>` : `<button class="follow-btn" data-client-id="${user.clientId}">Seguir</button>`;
                        userElement.innerHTML = `
                            <img src="${user.profilePic || 'https://via.placeholder.com/40'}" alt="Foto de ${user.displayName}" onclick="viewUserProfile('${user.clientId}')">
                            <p>${user.displayName || 'Anónimo'}</p>
                            ${user.clientId !== clientId ? followButton : ''}
                        `;
                        userResults.appendChild(userElement);
                    });
                    postsDiv.prepend(userResults);
                    postsDiv.querySelectorAll('.follow-btn').forEach(btn => {
                        btn.addEventListener('click', () => followUser(btn.dataset.clientId));
                    });
                    postsDiv.querySelectorAll('.unfollow-btn').forEach(btn => {
                        btn.addEventListener('click', () => unfollowUser(btn.dataset.clientId));
                    });
                }
            } else if (currentSection === 'videos') {
                renderPosts(posts.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)), videosDiv);
            } else {
                renderFollowers();
            }
        });
    </script>
</body>
</html>
